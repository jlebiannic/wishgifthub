meta {
  name: Accept Invitation
  type: http
  seq: 2
}

get {
  url: {{base_url}}/api/invite/{{invitation_token}}
  body: none
  auth: none
}

script:post-response {
  if (res.body.jwtToken) {
    bru.setEnvVar("user_token", res.body.jwtToken);
    bru.setEnvVar("user_id", res.body.id)
  }
}

tests {
  test("Status 200", function() {
    expect(res.getStatus()).to.equal(200);
  });
  
  test("Has JWT token", function() {
    expect(res.body.jwtToken).to.be.a('string');
  });
  
  test("Has invitation token", function() {
    expect(res.body.token).to.be.a('string');
  });
  
  test("Invitation accepted", function() {
    expect(res.body.accepted).to.equal(true);
  });

  test("JWT contains user and group info (decode to verify)", function() {
    // Le JWT devrait contenir userId, isAdmin et groupIds
    expect(res.body.jwtToken).to.be.a('string');
    expect(res.body.jwtToken.split('.')).to.have.lengthOf(3);
  });
}

  test("Has group info", function() {
    expect(res.body.groupId).to.be.a('string');
  });
  
  test("Is accepted", function() {
    expect(res.body.accepted).to.equal(true);
  });
}

docs {
  Accepte une invitation avec le token UUID.
  
  Cette requête :
  - Crée automatiquement un user avec l'email de l'invitation
  - Génère un token JWT pour le user
  - Ajoute le user au groupe
  - Marque l'invitation comme acceptée
  
  Le token JWT est automatiquement sauvegardé dans 'user_token'.
  
  Réponse contient :
  - jwtToken: le token JWT pour authentifier l'utilisateur
  - token: le token UUID de l'invitation
  - accepted: true
  - groupId: l'ID du groupe
}
