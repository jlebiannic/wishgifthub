meta {
  name: Test @PreAuthorize - User FAIL
  type: http
  seq: 2
}

post {
  url: {{base_url}}/api/groups
  body: json
  auth: bearer
}

auth:bearer {
  token: {{user_token}}
}

body:json {
  {
    "name": "Tentative par User",
    "type": "no√´l"
  }
}

tests {
  test("Status 403 Forbidden", function() {
    expect(res.getStatus()).to.equal(403);
  });

  test("Error about access denied", function() {
    // Spring Security retourne g√©n√©ralement "Access Denied" ou "Forbidden"
    const body = JSON.stringify(res.body).toLowerCase();
    const hasForbidden = body.includes('forbidden') ||
                         body.includes('access') ||
                         body.includes('denied');
    expect(hasForbidden).to.be.true;
  });
}

docs {
  üîí Test de s√©curit√© @PreAuthorize avec un USER

  Ce test v√©rifie que :
  1. JwtAuthFilter ajoute ROLE_USER aux authorities
  2. @PreAuthorize("hasRole('ADMIN')") √©value √† false
  3. AccessDeniedException est lanc√©e
  4. Spring Security retourne HTTP 403

  R√©sultat attendu : ‚ùå 403 Forbidden

  ‚ö†Ô∏è Ce test DOIT √©chouer pour prouver que la s√©curit√© fonctionne !
}
meta {
  name: Test @PreAuthorize - Admin OK
  type: http
  seq: 1
}

post {
  url: {{base_url}}/api/groups
  body: json
  auth: bearer
}

auth:bearer {
  token: {{admin_token}}
}

body:json {
  {
    "name": "Test @PreAuthorize Admin",
    "type": "no√´l"
  }
}

tests {
  test("Status 200 OK", function() {
    expect(res.getStatus()).to.equal(200);
  });

  test("Has group id", function() {
    expect(res.body.id).to.be.a('string');
  });

  test("Group name correct", function() {
    expect(res.body.name).to.equal("Test @PreAuthorize Admin");
  });
}

docs {
  ‚úÖ Test de @PreAuthorize avec un ADMIN

  Ce test v√©rifie que :
  1. JwtAuthFilter ajoute ROLE_ADMIN aux authorities
  2. @PreAuthorize("hasRole('ADMIN')") √©value √† true
  3. Le groupe est cr√©√© avec succ√®s

  R√©sultat attendu : ‚úÖ 200 OK - Groupe cr√©√©
}

